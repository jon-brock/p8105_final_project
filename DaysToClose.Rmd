---
title: "DaystoClose"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tseries)
library(forecast)
```

```{r}

new_311 <- nyc_311 %>% 
filter(borough != "Unspecified") 



nyc_tidy <- new_311 %>% 
    filter(borough != "Unspecified") %>% 
    separate(closed_date, 
             into = c("closed_month","closed_day","closed_year"), 
             sep = "\\/" ) %>%
    separate(closed_year, 
             into = c("closed_year","closed_time"), 
             sep = " ") %>% 
    mutate(
        created_year = as.numeric(created_year),
        created_month = as.numeric(created_month),
        created_day = as.numeric(created_day),
        city = as.factor(city),
        status = as.factor(status),
        borough = as.factor(borough),
        agency = as.factor(agency),
        complaint_type = as.factor(complaint_type),
        community_board = as.factor(community_board),
        open_complaint = ifelse(status == "Closed", yes = 0, no = 1),
        # open_complaint = ifelse(is.na(closed_year),  yes = 1, no = 0),
        complaint_simp = case_when(
            str_detect(complaint_type, 
                       regex("street", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sidewalk", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("curb", ignore_case = TRUE)) ~ "Street Condition",
            str_detect(complaint_type, 
                       regex("noise", ignore_case = TRUE)) ~ "Noise",
            str_detect(complaint_type, 
                       regex("heat", ignore_case = TRUE)) ~ "Heat",
            str_detect(complaint_type, 
                       regex("water", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("leak", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("plumbing", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("boiler", ignore_case = TRUE)) ~ "Water/plumbing",
            str_detect(complaint_type, 
                       regex("paint", ignore_case = TRUE)) ~ "Paint/Plaster",
            str_detect(complaint_type, 
                       regex("asbestos", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("lead", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("hazard", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("mold", ignore_case = TRUE)) ~ "Hazard Material",
            str_detect(complaint_type, 
                       regex("elevator", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("maintenance", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("electric", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("stairs", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("window", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("appliance", ignore_case = TRUE)) ~ "Maintenance",
            str_detect(complaint_type, 
                       regex("sanita", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("rodent", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("dirty", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sew", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("standing water", ignore_case = TRUE)) ~ "Sanitation",
            str_detect(complaint_type, 
                       regex("tree", ignore_case = TRUE)) ~ "Tree",
            str_detect(complaint_type, 
                       regex("parking", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("car", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("drive", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("vehicle", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("traffic", ignore_case = TRUE)) ~ "Car/Traffic",
            str_detect(complaint_type, 
                       regex("air", ignore_case = TRUE)) ~ "Air Quality",
            str_detect(complaint_type, 
                       regex("collection", ignore_case = TRUE)) ~ "Collection",
            str_detect(complaint_type, 
                       regex("homeless", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("panhandling", ignore_case = TRUE)) ~ "Homeless"),
        health_complaint = ifelse(
            complaint_simp %in% c("Heat", "Water/Plumbing", "Hazard Material", "Sanitation", "Air Quality"), yes = 1, no = 0),
        complaint_simp = as.factor(complaint_simp),
        open_health_complaint = case_when(
            open_complaint == 1 & health_complaint == 1 ~ 1,
            open_complaint == 0 | health_complaint == 0 ~ 0
        ),
        # openCorr = ifelse(status == "Closed", yes = 0, no = 1),
        status = as.factor(status)
    )

summary(nyc_tidy$status)

####### THIS CODE IS LOOKING AT WHAT IS MISSING FROM OUR COMPLAIN AGGREGATION
summary(nyc_tidy$complaint_simp)

test = nyc_tidy %>% 
    filter(is.na(complaint_simp))
summary(test$complaint_type)


```


```{r}

inc_df = read_csv("./Med_income_2017.csv") %>% 
    janitor::clean_names() %>% 
    mutate(
       # pop_1000s = round(total_population/1000, 0),
        inc_1000s = round(median_income/1000, 1),
        income_bracket = case_when(
            median_income < 30000 ~ "> 30k",
            median_income >= 30000 & median_income < 49999 ~ "30 to 49k",
            median_income >= 50000 & median_income < 99000 ~ "50 to < 99k",
            median_income > 100000 & median_income <= 349999 ~ "100 -349k",
            median_income > 350000~ "350k+"
        ),
        income_bracket = as.factor(income_bracket)
    )

# adding income to data and removing any observations that do not have a specific community board to link to income
add_inc = left_join(nyc_tidy, inc_df, by = "community_board") %>% 
    filter(is.na(median_income) == FALSE) %>% 
    mutate(
        year_fac = as.factor(created_year)
    )


```

We looked at number of complaints from 2014-2018 predicted by year, borough, community district (CD) level variables including median income (in the 1000s), total population (in the 1000s), percent non-hispanic black, percent hispanic, and number of unresolved complaints. 

Number of complaints by NYC community district:
The total number of complaints in significantly predicted by year, borough and CD number of unsolved complaints, percent Hispanic, and population total.

Number of health-related complaints by NYC community district:
Complaints were determined to be health related if they were about heat, hot water, sanitary conditions, poor air quality, or hazardous materials. The total number of health-related complaints in significantly predicted by borough and CD median income, percent non-Hispanic Black and Hispanic, and population total.

Number of unresolved complaints by NYC community district:
A complaint was labeled unresolved if its status was not labeled as "closed". The total number of unresolved complaints in significantly predicted by year of complaint, borough, and CD median income, number of unsolved complaints, percent non-Hispanic Black and Hispanic, and population total.

```{r}
add_inc %>%
    filter(status == "Closed") %>% 
    mutate(
        closed_year = as.numeric(closed_year),
        closed_month = as.numeric(closed_month),
        closed_day = as.numeric(closed_day)
    ) %>% 
    mutate(
        diff_year = abs(closed_year - created_year),
        diff_month = abs(closed_month - created_month),
        diff_day = abs(closed_day - created_day),
        diff_dayt = abs( diff_year*365 + diff_month*30 + diff_day ),
        diff_dayt = as.factor(diff_dayt)
    ) %>% 
    select(income_bracket, 
           borough, 
           diff_dayt,
           diff_year,
           diff_month,
           diff_day)  %>% 
    mutate(
        income_bracket = forcats::fct_relevel(income_bracket,"350k+" ,"100-349k", "50-99","30-49k",">30")
    ) %>% 
  group_by(diff_dayt, borough, income_bracket) %>% 
    summarize(
        n = n()
    ) %>% summary()
  ggplot(aes(x= diff_dayt, fill = income_bracket))+ geom_bar()+scale_fill_viridis_d()

  
  summary()


    
  #  filter(
    #    diff_dayt <10
  #  ) %>% 
    ggplot(aes(x= diff_dayt, fill = income_bracket))+ geom_density(alpha = 0.5)+scale_fill_viridis_d()


#figure out why is there values greater than 1300 days
```

```{r}

add_inc %>%
    filter(status == "Closed") %>% 
    mutate(
        closed_year = as.numeric(closed_year),
        closed_month = as.numeric(closed_month),
        closed_day = as.numeric(closed_day)
    ) %>% 
    mutate(
        diff_year = abs(closed_year - created_year),
        diff_month = abs(closed_month - created_month),
        diff_day = abs(closed_day - created_day),
        diff_dayt = abs( diff_year*365 + diff_month*30 + diff_day )
       # diff_dayt = as.factor(diff_dayt)
    ) %>% 
    select(income_bracket, 
           borough, 
           diff_dayt,
           diff_year,
           diff_month,
           diff_day) %>% 
    mutate(
        income_bracket = forcats::fct_relevel(income_bracket,"350k+" ,"100-349k", "50-99","30-49k",">30")
    ) %>% 
        ggplot(aes(x= diff_dayt))+geom_density()
    group_by(diff_dayt, borough, income_bracket) %>% 
    summarize(
        n = n()
    ) %>% 
    summary()
```

