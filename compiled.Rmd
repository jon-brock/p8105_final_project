---
title: "compiled"
author: "Ava Hamilton"
date: "12/4/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(RSocrata)
library(tidyverse)
library(viridis)
library(modelr)
library(mgcv)

```





# Importing and merging 311 data

I downloaded the data from the NYC Open data website filtering for each boorough and time frame 2014 - 2018.  Then I sampled from each dataset, containing 700k - 3 million rows, 100k data points in r, cleaned the `created_date` variable, and checked for equal sampling across the years. 

#### Bronx
```{r,eval=F}

read_csv("311_bronx.csv")%>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "bronx_311_100k.csv")

bronx<- read_csv("bronx_311_100k.csv")

table(bronx$year)



```

#### Brooklyn

```{r,eval=F}


read_csv("311_brooklyn.csv") %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "brooklyn_311_100k.csv")

brooklyn<- read_csv("brooklyn_311_100k.csv")

table(brooklyn100k$year)




```

#### Manhattan
```{r,eval=F}

read_csv("311_manhattan.csv") %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "manhattan_311_100k.csv")

manhattan<- read_csv("manhattan_311_100k.csv")

table(manhattan$year)



```

#### Queens
```{r,eval=F}


read_csv("311_queens.csv")%>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "queens_311_100k")

queens<- read_csv("queens_311_100k")

table(queens$year)



```


#### Staten Island

```{r,eval=F}
 

read_csv("311_statenisland.csv")  %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "statenisland_311_100k.csv")

statenisland <- read_csv("statenisland_311_100k.csv")

table(statenisland$year)


```

#### Unspecified
```{r,eval=F}


read_csv("311_unspecified.csv")  %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(.,"unspecified_311_100k")

unspec <- read_csv("unspecified_311_100k")

head(unspec)

table(unspec$year)


```

Combinging all the datasets of 100k data points.
```{r, eval=F}
rbind(brooklyn, manhattan, queens, bronx, statenisland, unspec) %>%
    rename(created_year = "year" , created_day = "day",created_month = "month",created_time = "time") %>%
    janitor::clean_names() %>%
   # write_csv(., "p8105nyc_311_100k.csv")
```



## NYC 311

Load and tidy the data. Data is 100k randomly sampled complaints from all neighborhoods across all NYC boroughs (600k total samples). Years sampled were 2014-2018.

Data downloaded from:
https://wetransfer.com/downloads/f8c5d6c17483e279ff56018db9c44cc420191201000026/c5f48b

```{r message = FALSE}
nyc <- read_csv(file = "../p8105nyc_311_100k.csv") %>% 
    janitor::clean_names()

nyc_tidy <- nyc %>%   
    filter(borough != "Unspecified") %>% 
    separate(closed_date, 
             into = c("closed_month","closed_day","closed_year"), 
             sep = "\\/" ) %>%
    separate(closed_year, 
             into = c("closed_year","closed_time"), 
             sep = " ") %>% 
    mutate(
        created_year = as.numeric(created_year),
        created_month = as.numeric(created_month),
        created_day = as.numeric(created_day),
        city = as.factor(city),
        status = as.factor(status),
        borough = as.factor(borough),
        agency = as.factor(agency),
        complaint_type = as.factor(complaint_type),
        community_board = as.factor(community_board),
        open_complaint = ifelse(status == "Closed", yes = 0, no = 1),
        # open_complaint = ifelse(is.na(closed_year),  yes = 1, no = 0),
        complaint_simp = case_when(
            str_detect(complaint_type, 
                       regex("street", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sidewalk", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("curb", ignore_case = TRUE)) ~ "Street Condition",
            str_detect(complaint_type, 
                       regex("noise", ignore_case = TRUE)) ~ "Noise",
            str_detect(complaint_type, 
                       regex("heat", ignore_case = TRUE)) ~ "Heat",
            str_detect(complaint_type, 
                       regex("water", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("leak", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("plumbing", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("boiler", ignore_case = TRUE)) ~ "Water/plumbing",
            str_detect(complaint_type, 
                       regex("paint", ignore_case = TRUE)) ~ "Paint/Plaster",
            str_detect(complaint_type, 
                       regex("asbestos", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("lead", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("hazard", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("mold", ignore_case = TRUE)) ~ "Hazard Material",
            str_detect(complaint_type, 
                       regex("elevator", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("maintenance", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("electric", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("stairs", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("window", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("appliance", ignore_case = TRUE)) ~ "Maintenance",
            str_detect(complaint_type, 
                       regex("sanita", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("rodent", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("dirty", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sew", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("standing water", ignore_case = TRUE)) ~ "Sanitation",
            str_detect(complaint_type, 
                       regex("tree", ignore_case = TRUE)) ~ "Tree",
            str_detect(complaint_type, 
                       regex("parking", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("car", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("drive", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("vehicle", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("traffic", ignore_case = TRUE)) ~ "Car/Traffic",
            str_detect(complaint_type, 
                       regex("air", ignore_case = TRUE)) ~ "Air Quality",
            str_detect(complaint_type, 
                       regex("collection", ignore_case = TRUE)) ~ "Collection",
            str_detect(complaint_type, 
                       regex("homeless", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("panhandling", ignore_case = TRUE)) ~ "Homeless"),
        health_complaint = ifelse(
            complaint_simp %in% c("Heat", "Water/Plumbing", "Hazard Material", "Sanitation", "Air Quality"), yes = 1, no = 0),
        complaint_simp = as.factor(complaint_simp),
        open_health_complaint = case_when(
            open_complaint == 1 & health_complaint == 1 ~ 1,
            open_complaint == 0 | health_complaint == 0 ~ 0
        ),
        # openCorr = ifelse(status == "Closed", yes = 0, no = 1),
        status = as.factor(status)
    )


```


Used skimr::skim, colnames, and levels(factor(nyc$complaint_type)) to investigate and tidy the data. New variables were created to establish a binary status for closed (0) or open (1) complaints.

Key variables include: `year`, `borough`, `community_board`, `complaint_type`, and `status`.

Newly added variables include:

1. `complaint_simp` - based on key words, condenses complaint types into the following categories: Air Quality, Car/Traffic, Collection, Hazard Material, Heat, Homeless, Maintenance, Noise, Paint/Plaster, Sanitation, Street Condition, Tree, and Water/plumbing.

2. `health_complaint` - binary yes (1) or no (0), based on health associated categories within `complaint_simp`.

3. `open_health_complaint` - binary categorization, either health complaint that is open (1), or non-health related complaint or closed health complaint (0).

4. `open_complaint` - binary categorization, closed `status` (0), open (1)

## Income and population characteristics data:

The variable, `community_board`, will be used to left join NYC 311 data with income and population characteristics data sourced from American Community Survey by Community District.

```{r message = FALSE}

inc_df = read_csv("./Med_income_2017.csv") %>% 
    janitor::clean_names() %>% 
    mutate(
        pop_1000s = round(total_population/1000, 0),
        inc_1000s = round(median_income/1000, 1),
        income_bracket = case_when(
            median_income >= 20000 & median_income <= 30000 ~ "20k-30k",
            median_income > 30000 & median_income <= 40000 ~ "30-40k",
            median_income > 40000 & median_income <= 50000 ~ "40-50k",
            median_income > 50000 & median_income <= 60000 ~ "50-60k",
            median_income > 60000 & median_income <= 70000 ~ "60-70k",
            median_income > 70000 & median_income <= 80000 ~ "70-80k",
            median_income > 80000 & median_income <= 90000 ~ "80-90k",
            median_income > 90000 & median_income <= 100000 ~ "90-100k",
            median_income > 100000 & median_income <= 125000 ~ "100-125k",
            median_income > 125000 & median_income <= 150000 ~ "125k+",
        ),
        income_bracket = as.factor(income_bracket)
    )

# adding income to data and removing any observations that do not have a specific community board to link to income
add_inc = left_join(nyc_tidy, inc_df, by = "community_board") %>% 
    filter(is.na(median_income) == FALSE) %>% 
    mutate(
        year_fac = as.factor(created_year)
    )


```
