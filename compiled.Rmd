---
title: "<span style='font-size: 25px'>Full Report</style>"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(viridis)
library(modelr)
library(mgcv)
library(arsenal)
library(rgdal)
library(leaflet)
library(dplyr)
library(ggplot2)
```


#### Reading in and tidying first dataset with NYC 311 complaint data 




# Importing and merging 311 data

I downloaded the data from the NYC Open data website filtering for each boorough and time frame 2014 - 2018.  Then I sampled from each dataset, containing 700k - 3 million rows, 100k data points in r, cleaned the `created_date` variable, and checked for equal sampling across the years. 

#### Bronx
```{r,eval=F}

read_csv("311_bronx.csv")%>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "bronx_311_100k.csv")

bronx<- read_csv("bronx_311_100k.csv")

table(bronx$year)



```

#### Brooklyn

```{r,eval=F}


read_csv("311_brooklyn.csv") %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "brooklyn_311_100k.csv")

brooklyn<- read_csv("brooklyn_311_100k.csv")

table(brooklyn100k$year)




```

#### Manhattan
```{r,eval=F}

read_csv("311_manhattan.csv") %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "manhattan_311_100k.csv")

manhattan<- read_csv("manhattan_311_100k.csv")

table(manhattan$year)



```

#### Queens
```{r,eval=F}


read_csv("311_queens.csv")%>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "queens_311_100k")

queens<- read_csv("queens_311_100k")

table(queens$year)



```


#### Staten Island

```{r,eval=F}
 

read_csv("311_statenisland.csv")  %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(., "statenisland_311_100k.csv")

statenisland <- read_csv("statenisland_311_100k.csv")

table(statenisland$year)


```

#### Unspecified
```{r,eval=F}


read_csv("311_unspecified.csv")  %>%
    sample_n(100000, replace = F) %>%
     separate(`Created Date`, into = c("month","day","year"), sep = "\\/" ) %>%
    separate(year, into = c("year","time"), sep = " ") %>%
    write_csv(.,"unspecified_311_100k")

unspec <- read_csv("unspecified_311_100k")

head(unspec)

table(unspec$year)


```

Combinging all the datasets of 100k data points.
```{r, eval=F}
rbind(brooklyn, manhattan, queens, bronx, statenisland, unspec) %>%
    rename(created_year = "year" , created_day = "day",created_month = "month",created_time = "time") %>%
    janitor::clean_names() %>%
   # write_csv(., "p8105nyc_311_100k.csv")
```



## NYC 311

Load and tidy the data. Data is 100k randomly sampled complaints from all neighborhoods across all NYC boroughs (600k total samples). Years sampled were 2014-2018.

Data downloaded from:
https://wetransfer.com/downloads/f8c5d6c17483e279ff56018db9c44cc420191201000026/c5f48b

```{r message = FALSE}
nyc <- read_csv(file = "./p8105nyc_311_100k.csv") %>% 
    janitor::clean_names()

nyc_tidy <- nyc %>%   
    filter(borough != "Unspecified") %>% 
    separate(closed_date, 
             into = c("closed_month","closed_day","closed_year"), 
             sep = "\\/" ) %>%
    separate(closed_year, 
             into = c("closed_year","closed_time"), 
             sep = " ") %>% 
    mutate(
        created_year = as.numeric(created_year),
        created_month = as.numeric(created_month),
        created_day = as.numeric(created_day),
        city = as.factor(city),
        status = as.factor(status),
        borough = as.factor(borough),
        agency = as.factor(agency),
        complaint_type = as.factor(complaint_type),
        community_board = as.factor(community_board),
        open_complaint = ifelse(status == "Closed", yes = 0, no = 1),
        # open_complaint = ifelse(is.na(closed_year),  yes = 1, no = 0),
        complaint_simp = case_when(
            str_detect(complaint_type, 
                       regex("street", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sidewalk", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("curb", ignore_case = TRUE)) ~ "Street Condition",
            str_detect(complaint_type, 
                       regex("noise", ignore_case = TRUE)) ~ "Noise",
            str_detect(complaint_type, 
                       regex("heat", ignore_case = TRUE)) ~ "Heat",
            str_detect(complaint_type, 
                       regex("water", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("leak", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("plumbing", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("boiler", ignore_case = TRUE)) ~ "Water/plumbing",
            str_detect(complaint_type, 
                       regex("paint", ignore_case = TRUE)) ~ "Paint/Plaster",
            str_detect(complaint_type, 
                       regex("asbestos", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("lead", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("hazard", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("mold", ignore_case = TRUE)) ~ "Hazard Material",
            str_detect(complaint_type, 
                       regex("elevator", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("maintenance", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("electric", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("stairs", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("window", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("appliance", ignore_case = TRUE)) ~ "Maintenance",
            str_detect(complaint_type, 
                       regex("sanita", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("rodent", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("dirty", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sew", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("standing water", ignore_case = TRUE)) ~ "Sanitation",
            str_detect(complaint_type, 
                       regex("tree", ignore_case = TRUE)) ~ "Tree",
            str_detect(complaint_type, 
                       regex("parking", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("car", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("drive", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("vehicle", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("traffic", ignore_case = TRUE)) ~ "Car/Traffic",
            str_detect(complaint_type, 
                       regex("air", ignore_case = TRUE)) ~ "Air Quality",
            str_detect(complaint_type, 
                       regex("collection", ignore_case = TRUE)) ~ "Collection",
            str_detect(complaint_type, 
                       regex("homeless", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("panhandling", ignore_case = TRUE)) ~ "Homeless"),
        health_complaint = ifelse(
            complaint_simp %in% c("Heat", "Water/Plumbing", "Hazard Material", "Sanitation", "Air Quality"), yes = 1, no = 0),
        complaint_simp = as.factor(complaint_simp),
        open_health_complaint = case_when(
            open_complaint == 1 & health_complaint == 1 ~ 1,
            open_complaint == 0 | health_complaint == 0 ~ 0
        ),
        # openCorr = ifelse(status == "Closed", yes = 0, no = 1),
        status = as.factor(status)
    )


```

#### Reading in and tidying second dataset with community district data

Used skimr::skim, colnames, and levels(factor(nyc$complaint_type)) to investigate and tidy the data. New variables were created to establish a binary status for closed (0) or open (1) complaints.

Key variables include: `year`, `borough`, `community_board`, `complaint_type`, and `status`.

Newly added variables include:

1. `complaint_simp` - based on key words, condenses complaint types into the following categories: Air Quality, Car/Traffic, Collection, Hazard Material, Heat, Homeless, Maintenance, Noise, Paint/Plaster, Sanitation, Street Condition, Tree, and Water/plumbing.

2. `health_complaint` - binary yes (1) or no (0), based on health associated categories within `complaint_simp`.

3. `open_health_complaint` - binary categorization, either health complaint that is open (1), or non-health related complaint or closed health complaint (0).

4. `open_complaint` - binary categorization, closed `status` (0), open (1)

## American Commmunity Survey, income and population characteristics:
We also included aggregated American Commmunity Survey (ACS) data in our analysis. The American Community Survey is conducted annually across the United States by the US Census Bureau to 3.5 million households. ACS provides annual and 5-year estimates of information by graphical region, including NYC Community Districts. We pulled population 5-year estimates (2013-2017) of total population, percent non-Hispanic White, percent non-Hispanic Black, percent Hispanic, and median income of each community district.

The variable, `community_board`, will be used to left join NYC 311 data with income and population characteristics data sourced from American Community Survey by Community District.

```{r message = FALSE}

inc_df = read_csv("./Med_income_2017.csv") %>% 
    janitor::clean_names() %>% 
    mutate(
        pop_1000s = round(total_population/1000, 0),
        inc_1000s = round(median_income/1000, 1),
        income_bracket = case_when(
            median_income >= 20000 & median_income <= 30000 ~ "20k-30k",
            median_income > 30000 & median_income <= 40000 ~ "30-40k",
            median_income > 40000 & median_income <= 50000 ~ "40-50k",
            median_income > 50000 & median_income <= 60000 ~ "50-60k",
            median_income > 60000 & median_income <= 70000 ~ "60-70k",
            median_income > 70000 & median_income <= 80000 ~ "70-80k",
            median_income > 80000 & median_income <= 90000 ~ "80-90k",
            median_income > 90000 & median_income <= 100000 ~ "90-100k",
            median_income > 100000 & median_income <= 125000 ~ "100-125k",
            median_income > 125000 & median_income <= 150000 ~ "125k+",
        ),
        income_bracket = as.factor(income_bracket)
    )


# adding income to data and removing any observations that do not have a specific community board to link to income
nyc_inc = left_join(nyc_tidy, inc_df, by = "community_board") 


```

__Exploratory analysis:__ Visualizations, summaries, and exploratory statistical analyses. Justify the steps you took, and show any major changes to your ideas.

# Final Plots:

#### Proportion open complaints per neighborhood

We first wanted to consider if there were differences in the number, type, or status of complaints across each neighborhood.

```{r}

nyc_plots <- nyc_inc %>% 
    group_by(area_name, created_year) %>%
    add_count(area_name, name = "number_complaints") %>% 
    mutate(
        num_unsolved = sum(open_complaint),
        num_health_complaint = sum(health_complaint),
        num_open_health = sum(open_health_complaint)
    ) %>% 
    select(-unique_key, -city, -park_borough, -agency, -agency_name, -descriptor, -incident_zip, -incident_address, -street_name, -cross_street_1, -cross_street_2, -intersection_street_1, -intersection_street_2, -landmark, -facility_type, -resolution_description, -resolution_action_updated_date, -bbl, -x_coordinate_state_plane, -y_coordinate_state_plane, -open_data_channel_type, -park_facility_name, -vehicle_type, -taxi_company_borough, -taxi_pick_up_location, -bridge_highway_name, -bridge_highway_direction, -bridge_highway_segment, -latitude, -longitude, -location, -road_ramp, -location_type, -address_type, -map_id)

nyc_plots %>%
    select(area_name, borough, complaint_simp, open_complaint) %>% 
    group_by(area_name, borough, complaint_simp, open_complaint) %>%
    summarize(n = n()) %>% 
    pivot_wider(names_from = open_complaint, values_from = n) %>% 
    rename(closed = `0`,
           open = `1`) %>% 
    mutate(proportion_open = open/(open + closed),
           total = (open + closed)) %>% 
    filter(!is.na(area_name), !is.na(total), !is.na(complaint_simp)) %>% 
    ggplot(aes(x = area_name, y = total, fill = complaint_simp)) + 
    geom_col() + 
    facet_wrap(~borough, scales = "free_x") + 
    theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
    xlab("Neighborhood") +
    ggtitle("Total and Type of Complaints Across Neighborhoods") +
    ylab("Total Complaints") + 
  labs(fill = "Complaint Type") +
  scale_fill_viridis(discrete = TRUE)

```

Looking at the total and type of complaint shows Inwood/Washington Heights to have a much greater number of complaints compared to the rest of Manhattan, many of which are related to Noise, Heat, Water/Plumbing, and Trees (possibly because of Inwood Park). Many more complaints are made in the "safer" area of the Bronx near the VA hospital, Fordham University, and Van Cortland Park (Highbridge/Concourse, Fordham/University Heights, Kingsbridge Heights/Bedford Park). More complaints are raised in St. George/Stapleton in Staten Island than other areas because it is a more populated area of the island in addition to being the more affluent area of the island.

We next considered how many of the total complaints in each neighborhood have been closed.

```{r}

nyc_plots %>%
    select(area_name, borough, complaint_simp, open_complaint) %>% 
    group_by(area_name, borough, complaint_simp, open_complaint) %>%
    summarize(n = n()) %>% 
    pivot_wider(names_from = open_complaint, values_from = n) %>% 
    rename(closed = `0`,
           open = `1`) %>% 
    mutate(proportion_open = open/(open + closed)) %>% 
    filter(!is.na(area_name), !is.na(proportion_open), !is.na(complaint_simp)) %>% 
    ggplot(aes(x = area_name, y = proportion_open, fill = complaint_simp)) + 
    geom_col() + 
    facet_wrap(~borough, scales = "free_x") + 
    theme(axis.text.x = element_text(angle = 75, hjust = 1)) +
    xlab("Neighborhood") +
    ggtitle("Proportion and Type of Complaints that are Open per Neighborhood") +
    ylab("Proportion Open") +
  labs(fill = "Complaint Type") +
    scale_fill_viridis(discrete = TRUE)
```

The above plot demonstrates that the highest proportion of open cases are complaints involving a tree. Air Quality and Car/Traffic are also addressed less than other complaints across all neighborhoods. Notably, Hazard Material complaints remain unaddressed in Morrisania/Crotona, Rockaway/Broad Channel and Coney Island. Depending on the neighborhood, Homeless complaints are typically left open.

#### Proportion of open complaints by income bracket

Because we saw a difference in the number of complaints and open complaints across each neighborhood, we wanted to understand how complaints are distributed based on `income_bracket`.

```{r}

p <- nyc_plots %>% 
    filter(!is.na(income_bracket)) %>% 
    group_by(income_bracket, borough, open_complaint) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = open_complaint, values_from = n) %>% 
    rename(closed = '0',
           open = '1')

p %>% mutate(proportion = (open/(open + closed))) %>% 
    ggplot(aes(x = income_bracket, y = proportion, fill = income_bracket)) +
    geom_col() +
    facet_wrap(~borough, scales = "free_x") +
    ggtitle("Proportion of Open Cases Within Each Income Bracket") +
    xlab("Income Bracket") +
    ylab("Proportion Open") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_viridis(discrete = TRUE) +
    labs(fill = "Income Bracket")

```

Surprisingly, across all boroughs (except Brooklyn) the proportion of open cases is greater in higher income groups compared to lower income groups.

We found the total number of cases per income bracket reflected the economic distribution of each neighborhood and was not informative as to which group filed the most complaints. As such, we did not include this plot.

#### Proportion of health related complaints by each income category:

Even though total complaint number was uninformative, we wanted to understand if a type of complaint was more prevalent within an income bracket. The following is a plot of the proportion of health related complaints (which includes: Air Quality, Heat, Hazard Material, Sanitation, and Water/Plumbing) out of all complaints filed.

```{r}

h <- nyc_plots %>% 
    filter(!is.na(income_bracket)) %>% 
    group_by(income_bracket, borough, health_complaint) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = health_complaint, values_from = n) %>% 
    rename(other = '0',
           health_related = '1')

h %>% mutate(proportion = (health_related/(health_related + other))) %>% 
    ggplot(aes(x = income_bracket, y = proportion, fill = income_bracket)) +
    geom_col() +
    facet_wrap(~borough, scales = "free_x") +
    ggtitle("Proportion of Health Related Complaints Within Each Income Bracket") +
    xlab("Income Bracket") +
    ylab("Proportion Health Related") +
    labs(fill = "Income Bracket") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_fill_viridis(discrete = TRUE)

```

It is apparent that health related complaints are proportionally higher in lower income groups across all boroughs of NYC.

## Income across complaint categories

#### Median income of each complaint category:

Given the difference in the proportion of health complaints across income brackets, we wanted to further investigate what incomes are associated with a given complaint.

```{r}

nyc_plots %>% 
    filter(!is.na(median_income),
           !is.na(complaint_simp)) %>% 
    # mutate(complaint_simp = fct_reorder(complaint_simp, median_income)) %>%
    ggplot(aes(x = complaint_simp, 
               y = (median_income/1000), 
               fill = complaint_simp)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          legend.position = "none") +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
    ylab("Median Income (thousands)") +
    xlab("Complaint Category") +
    ggtitle("Median Income of Community District where Complaint Category Occurs") +
    scale_fill_viridis(discrete = TRUE)

```

This plot demonstrates that neighborhoods with higher median incomes file more complaints relating to Homeless. Neighborhoods with lower median incomes file more complaints related to Heat, Maintenance, and Paint/Plaster.

## Status of complaints given race or income level

#### Open status given Community District Population

One initial question we wanted to address was whether or not the status of complaints was more readily addressed given population characteristics of a neighborhood.

The following is a plot of the proportion of cases that are open given the racial percentage of a community district.

```{r}
r <- nyc_plots %>% 
    pivot_longer(cols = per_black_nh:per_other, names_to = "race", values_to = "percent_pop") %>% 
    filter(!is.na(race),
           !is.na(percent_pop)) %>% 
    group_by(race, borough, percent_pop, open_complaint) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = open_complaint, values_from = n) %>% 
    rename(closed = '0',
           open = '1')

r %>% mutate(proportion = (open/(open + closed))) %>% 
    ggplot(aes(x = percent_pop, y = proportion, color = race)) +
    geom_point() +
    geom_smooth(se = FALSE) +
    xlab("Percentage of Community District Population") +
    ylab("Proportion Open") +
    ggtitle("Unresolved Complaints as a Function of Neighborhood Population") +
    scale_color_viridis(name = "Race", labels = c("Black", "Hispanic", "Other", "White"), discrete = TRUE)
    
```

The only trend we were able to discern is a decrease is the proportion of open cases as the percent hispanic population increases.

#### Days to close given income level

We were also curious whether the income bracket of a neighborhood affected the number of days until a complaint was closed.

```{r}

d <- nyc_plots %>%
    filter(status == "Closed") %>% 
    mutate(closed_year = as.numeric(closed_year),
        closed_month = as.numeric(closed_month),
        closed_day = as.numeric(closed_day)) %>% 
    filter(closed_year != 2047) %>% 
    mutate(diff_year = abs(closed_year - created_year),
        diff_month = abs(closed_month - created_month),
        diff_day = abs(closed_day - created_day),
        diff_dayt = abs(diff_year*365 + diff_month*30 + diff_day)) %>% 
    select(income_bracket,
           median_income,
           borough, 
           diff_dayt,
           diff_year,
           diff_month,
           diff_day) %>% 
    filter(diff_dayt <= 7,
           !is.na(income_bracket)) %>% 
    group_by(borough, income_bracket, diff_dayt) %>% 
    summarize(n = n()) %>% 
    pivot_wider(names_from = diff_dayt, values_from = n) %>% 
    rename(day0 = `0`,
           day1 = `1`,
           day2 = `2`,
           day3 = `3`,
           day4 = `4`,
           day5 = `5`,
           day6 = `6`,
           day7 = `7`)

d$total <- d %>% 
    ungroup() %>% 
    select(starts_with("day")) %>% 
    rowSums(.)

d %>% 
    pivot_longer(cols = day0:day7, names_to = "day", values_to = "day_total") %>% 
    mutate(day = recode(day, day0 = 0, day1 = 1, day2 = 2, day3 = 3, day4 = 4, day5 = 5, day6 = 6, day7 = 7),
           proportion = day_total/total) %>% 
    ggplot(aes(x = day, y = proportion, group = income_bracket, color = income_bracket)) + 
    geom_line() +
    facet_wrap(~borough, scales = "free_x") +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 7)) +
    scale_color_viridis(discrete = TRUE) +
    xlab("Days until Complaint Closed") +
    ylab("Proportion Complaints Closed") +
    ggtitle("Proportion of Complaints Closed Since Complaint Filed") +
    labs(color = "Income Bracket")


```

Looking at the total number of complaints largely reflects a difference in the total number of complaints filed by each group. We then looked at the proportion of complaints closed per day within an income bracket.

```{r}
nyc_plots %>%
    filter(status == "Closed") %>% 
    mutate(closed_year = as.numeric(closed_year),
        closed_month = as.numeric(closed_month),
        closed_day = as.numeric(closed_day)) %>% 
    filter(closed_year != 2047) %>% 
    mutate(diff_year = abs(closed_year - created_year),
        diff_month = abs(closed_month - created_month),
        diff_day = abs(closed_day - created_day),
        diff_dayt = abs(diff_year*365 + diff_month*30 + diff_day)) %>% 
    select(income_bracket,
           median_income,
           borough, 
           diff_dayt,
           diff_year,
           diff_month,
           diff_day) %>% 
    filter(diff_dayt <= 7,
           !is.na(income_bracket)) %>% 
    group_by(borough, income_bracket, diff_dayt) %>% 
    summarize(n = n()) %>% 
    ggplot(aes(x = diff_dayt, y = n, group = income_bracket, color = income_bracket)) + 
    geom_line() +
    facet_wrap(~borough, scales = "free_x") +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 7)) +
    scale_color_viridis(discrete = TRUE) +
    xlab("Days until Complaint Closed") +
    ylab("Total Complaints Closed") +
    ggtitle("Number of Complaints Closed Since Complaint Filed") +
    labs(color = "Income Bracket")
    
```

This revealed no difference in the number of days to close a complaint given the income bracket of a neighborhood.

# STEPHEN, describe plotly

# Calculate days to close
```{r}

#data with days to close information
nyc_data <- nyc_inc %>% 
 filter(status == "Closed" & closed_year <= 2018) %>% 
    mutate(
        closed_year = as.numeric(closed_year),
        closed_month = as.numeric(closed_month),
        closed_day = as.numeric(closed_day)
    ) %>% 
    mutate(
        diff_year = closed_year - created_year,
        diff_month = closed_month - created_month,
        diff_day = closed_day - created_day,
        diff_dayt =  diff_year*365 + diff_month*30 + diff_day
       # diff_dayt = as.factor(diff_dayt)
  ) %>% 
  mutate(
    status = as.character(status)
  ) %>% 
  mutate(
    income_bracket = forcats::fct_relevel(income_bracket, "125k+", "100-125k", "90-100k", "80-90k", "70-80k", "60-70k", "50-60k", "40-50k", "30-40k", "20-30k")
  ) %>% 
  drop_na(closed_year)
  
```
## Tables

Tables report median, and IQR given the skewness of our data and the count. 
```{r, message=FALSE, warning=FALSE}
mycontrols  <- tableby.control(test=F, total=T,
                               cat.simplify = F,
                               numeric.stats=c("N", "median", "q1q3"),
                               cat.stats=c("countpct"),
                               stats.labels=list(N='Count', median='Median', q1q3='Q1,Q3'),
                               digits = 1)

tab_clo<- tableby(created_year ~ diff_dayt + status  + borough, data = nyc_data, control = mycontrols)

tab_inc<- tableby(created_year ~ income_bracket, data = nyc_data, control = mycontrols)

tab_comp <- tableby(created_year ~ complaint_simp, data = nyc_data, control = mycontrols)

tab_com_clo_inc <- tableby(complaint_simp ~ diff_dayt +income_bracket + borough , data = nyc_data, control = mycontrols)

```

In table 1 the median and interquartile range of how many days it took for cases to close.  Given the data is skewed right I reported the median values being `1` to `2` days and largest interqutile range being `0 - 9` and smallest being `0 - 6` acroos years `2014 - 2018`. 

Most complaints are closed within a week with a high density of them being closed within a day or two. Additionally, we observe even distribution across all boroughs and closed cases. 
```{r, results="asis" }
summary(tab_clo, title = "NYC 311 Complaints Demographics: table 1")

```
For table 2 we see that individuals in the income bracket 40 - 50k (25.4%) made the most complaints through out all the years in this study while individuals in the 90 - 100k (2.6%)made the least comlaints consistently. 
```{r, results="asis" }
summary(tab_inc, title = "NYC 311 Complaints Demographics: table 2 ")
```
In table 3 we see that the most complaints are of noise (17.9%).  Interestingly we see that car/traffic complaints increase overtime that suggest an increase in conjestion. 
```{r,results="asis" }
summary(tab_comp, title = "NYC 311 Complaints Demographics: table 3 ")

```

Finally in table 4  cases with complaints that have something to do with tree, paint/plaster, and maintanance take the longest to close 11 - 12 days compared to the other compalaint cases that close with the said interquartile range of 0-9 days.  Taking a look at the incomme bracket we observe that higher income brackest mostly complain about the homeless (17.2%) while the lowest income clase mostly complain about heat (20.3%) and maintanance(20.9%) comparing accross all income brackets. Furthermore we can also see that Manhattan has most of its complaints related to air quality (38.8%), hazardous material (30.3%), homeless (77.4%), and noise (30.5%) comparing across all boroughs.  

```{r,results="asis" }
summary(tab_com_clo_inc , title = "NYC 311 Complaints Demographics: table 4 ")

```


### Aggregating data to community district and year level

To examine the effect of community district level variables on total number of complaints we must first aggregate to the community district level. We are also interested in how year effects the number of complaints in each district so we group by year as well to produce complaint totals for each year and community district.

Once we have complaint totals, we do not want individual complaint information anymore. We select distinct year * community district observations. 

```{r message = FALSE}

# grouping by community district and year
cb_group_year = nyc_inc %>% 
    filter(is.na(median_income) == FALSE) %>% 
    group_by(community_board, created_year) %>%
    add_count(community_board, name = "number_complaints") %>% 
    mutate(
        num_unsolved = sum(open_complaint),
        num_health_complaint = sum(health_complaint),
        num_open_health = sum(open_health_complaint)
    ) %>% 
    select(number_complaints, num_unsolved, num_open_health, everything())


########## including year
cb_group_year_distinct = cb_group_year %>% 
    select(community_board, number_complaints, inc_1000s, num_unsolved, num_health_complaint, borough, per_black_nh, per_hisp, per_white_nh, median_income, num_open_health, created_year, pop_1000s) %>% 
    distinct() %>% 
    arrange(community_board) %>% 
    mutate(
        borough = relevel(borough, ref = "MANHATTAN")
        )

cb_group_year_distinct = within(cb_group_year_distinct, borough <- relevel(borough, ref = "MANHATTAN"))

manhanttan_distinct = cb_group_year_distinct %>% 
    filter(borough == "MANHATTAN")

brooklyn_distinct = cb_group_year_distinct %>% 
    filter(borough == "BROOKLYN")

bronx_distinct = cb_group_year_distinct %>% 
    filter(borough == "BRONX")

queens_distinct = cb_group_year_distinct %>% 
    filter(borough == "QUEENS")

SI_distinct = cb_group_year_distinct %>% 
    filter(borough == "STATEN ISLAND")


```

```{r, warning=FALSE, include = FALSE}
nyc <- read_csv(file = "./p8105nyc_311_100k.csv") %>% 
    janitor::clean_names()

nyc_tidy <- nyc %>% 
    filter(borough != "Unspecified") %>% 
    separate(closed_date, 
             into = c("closed_month","closed_day","closed_year"), 
             sep = "\\/" ) %>%
    separate(closed_year, 
             into = c("closed_year","closed_time"), 
             sep = " ") %>% 
    mutate(
        created_year = as.numeric(created_year),
        created_month = as.numeric(created_month),
        created_day = as.numeric(created_day),
        city = as.factor(city),
        status = as.factor(status),
        borough = as.factor(borough),
        agency = as.factor(agency),
        complaint_type = as.factor(complaint_type),
        community_board = as.factor(community_board),
       open_complaint = ifelse(status == "Closed", yes = 0, no = 1),
      # open_complaint = ifelse(is.na(closed_year),  yes = 1, no = 0),
        complaint_simp = case_when(
            str_detect(complaint_type, 
                       regex("street", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sidewalk", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("curb", ignore_case = TRUE)) ~ "Street Condition",
            str_detect(complaint_type, 
                       regex("noise", ignore_case = TRUE)) ~ "Noise",
            str_detect(complaint_type, 
                       regex("heat", ignore_case = TRUE)) ~ "Heat",
            str_detect(complaint_type, 
                       regex("water", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("leak", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("plumbing", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("boiler", ignore_case = TRUE)) ~ "Water/plumbing",
            str_detect(complaint_type, 
                       regex("paint", ignore_case = TRUE)) ~ "Paint/Plaster",
            str_detect(complaint_type, 
                       regex("asbestos", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("lead", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("hazard", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("mold", ignore_case = TRUE)) ~ "Hazard Material",
            str_detect(complaint_type, 
                       regex("elevator", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("maintenance", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("electric", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("stairs", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("window", ignore_case = TRUE)) 
            |str_detect(complaint_type, 
                        regex("appliance", ignore_case = TRUE)) ~ "Maintenance",
            str_detect(complaint_type, 
                       regex("sanita", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("rodent", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("dirty", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("sew", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("standing water", ignore_case = TRUE)) ~ "Sanitation",
            str_detect(complaint_type, 
                       regex("tree", ignore_case = TRUE)) ~ "Tree",
            str_detect(complaint_type, 
                       regex("parking", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("car", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("drive", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("vehicle", ignore_case = TRUE))
            |str_detect(complaint_type,  
                        regex("traffic", ignore_case = TRUE)) ~ "Car/Traffic",
            str_detect(complaint_type, 
                       regex("air", ignore_case = TRUE)) ~ "Air Quality",
            str_detect(complaint_type, 
                       regex("collection", ignore_case = TRUE)) ~ "Collection",
            str_detect(complaint_type, 
                       regex("homeless", ignore_case = TRUE))
            |str_detect(complaint_type, 
                        regex("panhandling", ignore_case = TRUE)) ~ "Homeless"),
        health_complaint = ifelse(
            complaint_simp %in% c("Heat", "Water/Plumbing", "Hazard Material", "Sanitation", "Air Quality"), yes = 1, no = 0),
        complaint_simp = as.factor(complaint_simp),
        open_health_complaint = case_when(
            open_complaint == 1 & health_complaint == 1 ~ 1,
            open_complaint == 0 | health_complaint == 0 ~ 0
        ),
       # openCorr = ifelse(status == "Closed", yes = 0, no = 1),
        status = as.factor(status)
    )
```

Visualization

```{r, warning = FALSE, include=FALSE}
inc_df = read_csv("./Med_income_2017.csv") %>% 
    janitor::clean_names() %>% 
    mutate(
        inc_1000s = round(median_income/1000, 1),
        income_bracket = case_when(
            median_income >= 20000 & median_income <= 30000 ~ "20k-30k",
            median_income > 30000 & median_income <= 40000 ~ "30-40k",
            median_income > 40000 & median_income <= 50000 ~ "40-50k",
            median_income > 50000 & median_income <= 60000 ~ "50-60k",
            median_income > 60000 & median_income <= 70000 ~ "60-70k",
            median_income > 70000 & median_income <= 80000 ~ "70-80k",
            median_income > 80000 & median_income <= 90000 ~ "80-90k",
            median_income > 90000 & median_income <= 100000 ~ "90-100k",
            median_income > 100000 & median_income <= 125000 ~ "100-125k",
            median_income > 125000 & median_income <= 150000 ~ "125k+",
        ),
        income_bracket = as.factor(income_bracket),
        income_bracket = fct_relevel(income_bracket, c("20k-30k", "30-40k", "40-50k", "50-60k", "60-70k", "70-80k", "80-90k", "90-100k", "100-125k", "125k+"))
    )
nyc_inc = left_join(nyc_tidy, inc_df, by = "community_board")
```

#### 311 Complaints in NYC in 2018 

```{r warning = FALSE}
pal <- colorFactor(
  palette = "viridis",
  domain = unique(nyc_tidy$complaint_simp))

nyc_inc %>% 
  filter(created_year == "2018") %>%
  drop_na(complaint_simp) %>% 
  sample_n(10000) %>% 
  mutate(click_label = str_c("<br>Complaint type: ", complaint_simp, "<br>Neighborhood: ", area_name, "<br>Median Income: $", median_income, "<br>Status: ", status)) %>%
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircleMarkers(lat = ~latitude, lng = ~longitude, radius = .1, color = ~pal(complaint_simp), popup = ~click_label) %>% 
  addLegend("bottomright", pal = pal, values = ~complaint_simp,
    title = "Type of Complaints in NYC in 2018",
    opacity = 1)
```

## What neighborhood characteristics effect number and type of complaints in each community district? 

We conducted linear models to examine predictors of number of complaints from 2014-2018 per community district. Our three outcomes were:

1) Total number of complaints
2) Number of health complaints
3) Number of unresolved complaints.

We looked at these categories of complaints from 2014-2018 predicted by year, and community district level variables including median income (in the 1000s), total population (in the 1000s), percent non-hispanic black and percent Hispanic. For outcomes 1 and 2 we included number of unresolved complaints as a predictor as well. 

As we have equal complaints across borough we startified our analysis to predict number of complaints within each borough.

#### 1) Number of complaints by NYC community district:

##### **A) Bronx**

```{r message = FALSE}

# number of complaints
options(scipen = 5)

nom_comp_bronx = lm(number_complaints ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = bronx_distinct)
summary(nom_comp_bronx)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_bronx) %>% broom::glance() %>% knitr::kable()

```

##### **B) Brooklyn**

```{r message = FALSE}
# Brooklyn
nom_comp_brook = lm(number_complaints ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = brooklyn_distinct)
summary(nom_comp_brook)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_brook) %>% broom::glance() %>% knitr::kable()

```

##### **C) Manhattan**

```{r message = FALSE}
# Manhattan

nom_comp_manhattan = lm(number_complaints ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = manhanttan_distinct)
summary(nom_comp_manhattan)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_manhattan) %>% broom::glance() %>% knitr::kable()

```

##### **D) Queens**

```{r message = FALSE}
# Queens
nom_comp_queens = lm(number_complaints ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = queens_distinct)
summary(nom_comp_queens)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_queens) %>% broom::glance() %>% knitr::kable()

```

##### **E) Staten Island**

```{r message = FALSE}
# SI
nom_comp_SI = lm(number_complaints ~ inc_1000s + num_unsolved + per_black_nh +created_year, data = SI_distinct)
summary(nom_comp_SI)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_SI) %>% broom::glance() %>% knitr::kable()

```

##### **Residuals**


```{r}

par(mfrow = c(2,3))
plot(nom_comp_bronx, which = 1, main = "Bronx
")
plot(nom_comp_brook, which = 1, main = "Brooklyn
")
plot(nom_comp_manhattan, which = 1, main = "Manhattan
")
plot(nom_comp_queens, which = 1, main = "Queens
")
plot(nom_comp_SI, which = 1, main = "Staten Island
")


```



*Comments:*

In the Bronx, on average, for each additional year we see `r round(pull((summary(nom_comp_bronx)%>% broom::tidy()) %>% filter(term == "created_year"),estimate),0)` more complaints in each community district, for each additional 1000 people in a CD we see `r round(pull((summary(nom_comp_bronx)  %>% broom::tidy()) %>% filter(term == "pop_1000s"),estimate),0)` more complaints, and for each $1000 increase in median income we see `r -1*round(pull((summary(nom_comp_bronx)  %>% broom::tidy()) %>% filter(term == "inc_1000s"),estimate),0)` *_fewer_* complaints.

In Manhattan and Queens we see an effect on total number of complaints by number of unresolved complaints. On average, for each additional unresolved complaint people in Manhattan and Queens will have `r round(pull((summary(nom_comp_manhattan)  %>% broom::tidy()) %>% filter(term == "num_unsolved"),estimate),0)` and `r round(pull((summary(nom_comp_queens) %>% broom::tidy()) %>% filter(term == "num_unsolved"),estimate),0)` more complaints respectively.

Based on the adjusted R-squared values, number of complaints in a CD range from  `r 100*round(pull((summary(nom_comp_manhattan) %>% broom::glance()),adj.r.squared),4)`% in Manhattan to `r 100*round(pull((summary(nom_comp_SI) %>% broom::glance()),adj.r.squared),4)`% in Staten Island predicted by this combination of variables. Residuals appear to follow normal distributions.



#### 2) Number of health-related complaints by NYC community district:

##### **A) Bronx**

```{r message = FALSE}

# number of complaints
options(scipen = 5)

nom_comp_h_bronx = lm(num_health_complaint ~  inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s + created_year, data = bronx_distinct)
summary(nom_comp_h_bronx)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_h_bronx) %>% broom::glance() %>% knitr::kable()

```

##### **B) Brooklyn**

```{r message = FALSE}
# Brooklyn
nom_comp_h_brook = lm(num_health_complaint ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = brooklyn_distinct)
summary(nom_comp_h_brook)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_h_brook) %>% broom::glance() %>% knitr::kable()

```

##### **C) Manhattan**

```{r message = FALSE}
# Manhattan

nom_comp_h_manhattan = lm(num_health_complaint ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = manhanttan_distinct)
summary(nom_comp_h_manhattan)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_h_manhattan) %>% broom::glance() %>% knitr::kable()

```

##### **D) Queens**

```{r message = FALSE}
# Queens
nom_comp_h_queens = lm(num_health_complaint ~ inc_1000s + num_unsolved + per_black_nh + per_hisp + pop_1000s +created_year, data = queens_distinct)
summary(nom_comp_h_queens)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_h_queens) %>% broom::glance() %>% knitr::kable()

```

##### **E) Staten Island**

```{r message = FALSE}
# SI
nom_comp_h_SI = lm(num_health_complaint ~ inc_1000s + num_unsolved + per_black_nh +created_year, data = SI_distinct)
summary(nom_comp_h_SI)  %>% broom::tidy() %>% knitr::kable()
summary(nom_comp_h_SI) %>% broom::glance() %>% knitr::kable()

```

##### **Residuals**


```{r}

par(mfrow = c(2,3))
plot(nom_comp_h_bronx, which = 1, main = "Bronx
")
plot(nom_comp_h_brook, which = 1, main = "Brooklyn
")
plot(nom_comp_h_manhattan, which = 1, main = "Manhattan
")
plot(nom_comp_h_queens, which = 1, main = "Queens
")
plot(nom_comp_h_SI, which = 1, main = "Staten Island
")


```


*Comments:*

Complaints were determined to be health related if they were about heat, hot water, sanitary conditions, poor air quality, or hazardous materials.

In Manhattan and Queens we see a significant effect on total number of health related complaints by median income of the CD. On average, for each $1000 increase in median income we see `r -1*round(pull((summary(nom_comp_h_manhattan)  %>% broom::tidy()) %>% filter(term == "inc_1000s"),estimate),0)` more health-related complaints in Manhattan `r -1*round(pull((summary(nom_comp_h_queens)  %>% broom::tidy()) %>% filter(term == "inc_1000s"),estimate),0)` *_fewer_* health-related complaints in Queens.

Based on the adjusted R-squared values, number of health related complaints in a CD range from  `r 100*round(pull((summary(nom_comp_h_brook) %>% broom::glance()),adj.r.squared),4)`% in Brooklyn to `r 100*round(pull((summary(nom_comp_h_SI) %>% broom::glance()),adj.r.squared),4)`% in Staten Island predicted by this combination of variables. The plots of the residuals indicate that future analyses should increase or adjust the predictors to better fit the data.


#### 3) Number of unresolved complaints by NYC community district:

##### **A) Bronx**

```{r message = FALSE}

# number of complaints
options(scipen = 5)

nom_unres_bronx = lm(num_unsolved ~ inc_1000s + per_black_nh + per_hisp + pop_1000s +created_year, data = bronx_distinct)
summary(nom_unres_bronx)  %>% broom::tidy() %>% knitr::kable()
summary(nom_unres_bronx) %>% broom::glance() %>% knitr::kable()

```

##### **B) Brooklyn**

```{r message = FALSE}
# Brooklyn
nom_unres_brook = lm(num_unsolved ~ inc_1000s + per_black_nh + per_hisp + pop_1000s +created_year, data = brooklyn_distinct)
summary(nom_unres_brook)  %>% broom::tidy() %>% knitr::kable()
summary(nom_unres_brook) %>% broom::glance() %>% knitr::kable()

```

##### **C) Manhattan**

```{r message = FALSE}
# Manhattan

nom_unres_manhattan = lm(num_unsolved ~ inc_1000s + per_black_nh + per_hisp + pop_1000s +created_year, data = manhanttan_distinct)
summary(nom_unres_manhattan)  %>% broom::tidy() %>% knitr::kable()
summary(nom_unres_manhattan) %>% broom::glance() %>% knitr::kable()

```

##### **D) Queens**

```{r message = FALSE}
# Queens
nom_unres_queens = lm(num_unsolved ~ inc_1000s + per_black_nh + per_hisp + pop_1000s +created_year, data = queens_distinct)
summary(nom_unres_queens)  %>% broom::tidy() %>% knitr::kable()
summary(nom_unres_queens) %>% broom::glance() %>% knitr::kable()

```

##### **E) Staten Island**

```{r message = FALSE}
# SI
nom_unres_SI = lm(num_unsolved ~ inc_1000s + per_black_nh +created_year, data = SI_distinct)
summary(nom_unres_SI)  %>% broom::tidy() %>% knitr::kable()
summary(nom_unres_SI) %>% broom::glance() %>% knitr::kable()

```

##### **Residuals**


```{r}

par(mfrow = c(2,3))
plot(nom_unres_bronx, which = 1, main = "Bronx
")
plot(nom_unres_brook, which = 1, main = "Brooklyn
")
plot(nom_unres_manhattan, which = 1, main = "Manhattan
")
plot(nom_unres_queens, which = 1, main = "Queens
")
plot(nom_unres_SI, which = 1, main = "Staten Island
")


```



*Comments:*


A complaint was labeled unresolved if its status was not labeled as "closed". For all boroughs but Staten Island, year is, on average, a significant predictor if number of unresolved complaints for each CD. 

In Brooklyn and Queens we see significant effect on total number of unresolved complaints by the percent non-Hispanic Black population. On average, we see `r 5*round(pull((summary(nom_unres_brook)  %>% broom::tidy()) %>% filter(term == "per_black_nh"),estimate),0)` and `r 5*round(pull((summary(nom_unres_queens)  %>% broom::tidy()) %>% filter(term == "per_black_nh"),estimate),0)` more unresolved complaints for each additonal 5% increase in non-Hispanic Black population in Brooklyn and Queens respectively.

Based on the adjusted R-squared values, number of unresolved complaints in a CD range from  `r 100*round(pull((summary(nom_unres_SI) %>% broom::glance()),adj.r.squared),4)`% in Staten Island to `r 100*round(pull((summary(nom_unres_brook) %>% broom::glance()),adj.r.squared),4)`% in The Bronx predicted by this combination of variables. The plots of the residuals indicate that future analyses should increase or adjust the predictors to better fit the data.


## Discussion

Between 2014 and 2018, approximately 22 million 311 complaints were made across the 5 boroughs in NYC. We were interested in how complaints differ by borough and community district. Based on our descriptive figures, mapped data, and linear models of NYC 311 complaint data, we see that there are a few key factors that play into how types of complaints are dispersed across the city.

With approximately 5000 311 complaints made everyday, a majority of which close within the week (66%), it is interesting to look into where the open complaints remain. We see that in four out of the five boroughs, race has an impact on number of unresolved complaints, where an increase in non-Hispanic Black population predicts an increase in number of unresolved complaints. In Manhattan we see the opposite effect, where an increase in non-Hispanic Black population predicts a decrease in number of unresolved complaints.

As the income disparity in New York City is one of the greatest in the nation, we wanted to see how median household income of a neighborhood also effected complaints. [https://dailygazette.com/article/2018/07/19/study-finds-n-y-income-disparity-greatest-in-nation]. We found that community districts with higher incomes had different types of complaints than those with lower incomes. By borough we see that in The Bronx, Brooklyn, and Queens, an increase in median income of a community district resulted in a decrease in total health-realted complaints. These areas are less likely to have calls related to water issues, rodents, and hazardous materials including asbestos and lead. What we do see, however, is that areas with higher incomes produce more 311 complaints about the homeless population. It is safe to assume that wealthier areas do not necessarily have more homeless residents, but that a panhandler is seen as more problematic in areas that have a greater density of wealth.

Ultimately we see that 311 complaints come from all over the city, regardless of community district economic or racial background, and the data is a minefield for answering niche questions about New York City life.